<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone History - UAV Deconfliction System</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.5rem;
            color: #667eea;
        }

        .logo h1 {
            font-size: 1.8rem;
            color: #333;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: #667eea;
            color: white;
        }

        .history-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .drone-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .drone-card {
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }

        .drone-card.active {
            border-left-color: #4CAF50;
        }

        .drone-card.inactive {
            border-left-color: #9E9E9E;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .mission-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .mission-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .mission-item.completed {
            border-left-color: #4CAF50;
        }

        .mission-item.failed {
            border-left-color: #F44336;
        }

        .mission-item.active {
            border-left-color: #FF9800;
        }

        .plot-container {
            height: 400px;
            width: 100%;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            padding: 15px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #667eea;
            color: white;
            text-decoration: none;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .time-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .time-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
        }

        .drone-legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #F44336;
            background: #ffebee;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-history"></i>
                <div>
                    <h1>Flight History - All Drones</h1>
                    <p>UAV Deconfliction System</p>
                </div>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="/visualization" class="nav-link"><i class="fas fa-map"></i> Visualization</a>
                <a href="/history/1" class="nav-link active"><i class="fas fa-history"></i> History</a>
            </div>
        </header>

        <!-- Time Controls -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-clock"></i> Time Range Selection</h2>
            </div>
            <div class="time-controls">
                <div>
                    <label>Start Time:</label>
                    <input type="datetime-local" id="start-time" class="time-input" value="">
                </div>
                <div>
                    <label>End Time:</label>
                    <input type="datetime-local" id="end-time" class="time-input" value="">
                </div>
                <button class="btn" onclick="loadHistoricalData()">
                    <i class="fas fa-sync-alt"></i> Load History
                </button>
                <button class="btn" onclick="loadFutureTrajectories()">
                    <i class="fas fa-forward"></i> Load Future Paths
                </button>
                <button class="btn secondary" onclick="resetTimeRange()">
                    <i class="fas fa-undo"></i> Reset to Now
                </button>
            </div>
        </div>

        <div class="history-grid">
            <!-- Drone Status Overview -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-drone"></i> Drone Fleet Status</h2>
                </div>
                <div class="drone-grid" id="drone-status-grid">
                    <div class="loading">Loading drone status...</div>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="loadDroneDetails()">
                        <i class="fas fa-sync-alt"></i> Refresh Status
                    </button>
                    <button class="btn" onclick="downloadAllTrajectories()">
                        <i class="fas fa-download"></i> Export All Data
                    </button>
                </div>
            </div>

            <!-- System Statistics -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-bar"></i> System Statistics</h2>
                </div>
                <div class="stats-grid" id="system-stats">
                    <div class="loading">Loading statistics...</div>
                </div>
                <div class="plot-container" id="stats-chart"></div>
            </div>

            <!-- 3D Trajectory Visualization -->
            <div class="card full-width">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-cube"></i> 3D Trajectory Visualization</h2>
                    <div class="drone-legend" id="trajectory-legend"></div>
                </div>
                <div class="plot-container" id="trajectory-3d-plot"></div>
                <div class="btn-group">
                    <button class="btn" onclick="plot3DTrajectories('historical')">
                        <i class="fas fa-history"></i> Historical Paths
                    </button>
                    <button class="btn" onclick="plot3DTrajectories('future')">
                        <i class="fas fa-forward"></i> Future Paths
                    </button>
                    <button class="btn" onclick="plot3DTrajectories('both')">
                        <i class="fas fa-layer-group"></i> Both
                    </button>
                    <button class="btn" onclick="toggleTrajectoryView()">
                        <i class="fas fa-eye"></i> Toggle View
                    </button>
                </div>
            </div>


            <!-- Mission History -->
            <div class="card full-width">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-tasks"></i> Recent Missions</h2>
                </div>
                <div class="mission-list" id="mission-history">
                    <div class="loading">Loading mission history...</div>
                </div>
            </div>

            <!-- Conflict History -->
            <div class="card full-width">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-exclamation-triangle"></i> Conflict History</h2>
                </div>
                <div id="conflict-history">
                    <div class="loading">Loading conflict history...</div>
                </div>
            </div>
        </div>

        <footer>
            <p>UAV Deconfliction System | FlytBase Robotics Assignment 2025</p>
            <p>Real-time flight history and trajectory analysis for all drones</p>
        </footer>
    </div>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        // Global variables
        let historicalTrajectories = {};
        let futureTrajectories = {};
        let currentDrones = {};
        let systemStats = {};
        let missions = [];
        let conflicts = [];

        // Drone colors for visualization
        const DRONE_COLORS = {
            1: '#FF6B6B',
            2: '#4ECDC4',
            3: '#45B7D1',
            4: '#96CEB4'
        };

        // Initialize on load
        window.onload = function() {
            // Set default time range (last 1 hour)
            const endTime = new Date();
            const startTime = new Date(endTime.getTime() - (60 * 60 * 1000));
            
            document.getElementById('start-time').value = formatDateTimeLocal(startTime);
            document.getElementById('end-time').value = formatDateTimeLocal(endTime);
            
            // Load all data
            loadAllData();
            
            // Set up periodic refresh
            setInterval(loadDroneStatus, 5000);
            setInterval(loadSystemStats, 30000);
        };

        // Format datetime for input field
        function formatDateTimeLocal(date) {
            return date.toISOString().slice(0, 16);
        }

        // Parse datetime from input field
        function parseDateTimeLocal(value) {
            if (!value) return new Date();
            return new Date(value);
        }

        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadDroneStatus(),
                loadHistoricalData(),
                loadMissionHistory(),
                loadSystemStats(),
                loadConflictHistory()
            ]);
        }

        // Load drone status
        async function loadDroneStatus() {
            try {
                const response = await fetch('/api/drones');
                const data = await response.json();

                if (data.success && data.drones) {
                    currentDrones = data.drones;
                    displayDroneStatus();
                }
            } catch (error) {
                console.error('Error loading drone status:', error);
                showError('drone-status-grid', 'Failed to load drone status');
            }
        }

        // Display drone status
        function displayDroneStatus() {
            const grid = document.getElementById('drone-status-grid');
            let html = '';

            currentDrones.forEach(drone => {
                const pos = drone.position || {};
                const statusClass = drone.status === 'active' ? 'active' : 'inactive';
                const batteryColor = drone.battery > 50 ? '#4CAF50' : 
                                   drone.battery > 20 ? '#FF9800' : '#F44336';

                html += `
                    <div class="drone-card ${statusClass}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="font-size: 1.2rem;">Drone ${drone.id}</strong>
                            <span style="background: ${DRONE_COLORS[drone.id]}; 
                                         width: 20px; height: 20px; border-radius: 50%;"></span>
                        </div>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Status:</span>
                                <span style="color: ${drone.armed ? '#4CAF50' : '#F44336'}">
                                    ${drone.status || 'Unknown'}
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Battery:</span>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <div style="flex-grow: 1; background: #e0e0e0; height: 8px; border-radius: 4px;">
                                        <div style="width: ${drone.battery}%; 
                                                  background: ${batteryColor}; 
                                                  height: 100%; border-radius: 4px;"></div>
                                    </div>
                                    <span>${drone.battery}%</span>
                                </div>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Position:</span>
                                <span>X: ${pos.x?.toFixed(1) || 0}m<br>
                                      Y: ${pos.y?.toFixed(1) || 0}m<br>
                                      Z: ${pos.z?.toFixed(1) || 0}m</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">GPS:</span>
                                <span>${pos.lat?.toFixed(6) || 'N/A'}<br>
                                      ${pos.lon?.toFixed(6) || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        // Load historical trajectories
        async function loadHistoricalData() {
            try {
                const startTime = parseDateTimeLocal(document.getElementById('start-time').value);
                const endTime = parseDateTimeLocal(document.getElementById('end-time').value);
                
                if (startTime >= endTime) {
                    alert('Start time must be before end time');
                    return;
                }

                // For now, use the existing API endpoint
                const response = await fetch(`/api/historical/trajectories`);
                const data = await response.json();

                if (data.success) {
                    historicalTrajectories = data.trajectories || {};
                    plot3DTrajectories('historical');
                    plotAltitudeChart();
                    plotDistanceChart();
                    updateLegend();
                }
            } catch (error) {
                console.error('Error loading historical data:', error);
                showError('trajectory-3d-plot', 'Failed to load historical trajectories');
            }
        }

        // Load future trajectories
        async function loadFutureTrajectories() {
            try {
                const startTime = parseDateTimeLocal(document.getElementById('start-time').value);
                const endTime = parseDateTimeLocal(document.getElementById('end-time').value);

                const response = await fetch(`/api/future/trajectories?start_time=${startTime.toISOString()}&end_time=${endTime.toISOString()}`);
                const data = await response.json();

                if (data.success) {
                    futureTrajectories = data.trajectories || {};
                    plot3DTrajectories('future');
                    updateLegend();
                }
            } catch (error) {
                console.error('Error loading future trajectories:', error);
                showError('trajectory-3d-plot', 'Failed to load future trajectories');
            }
        }

        // Plot 3D trajectories
        function plot3DTrajectories(type = 'historical') {
            const traces = [];
            
            // Plot historical trajectories
            if (type === 'historical' || type === 'both') {
                Object.keys(historicalTrajectories).forEach(droneId => {
                    const trajectory = historicalTrajectories[droneId];
                    if (trajectory && trajectory.length > 0) {
                        const x = trajectory.map(p => p.x);
                        const y = trajectory.map(p => p.y);
                        const z = trajectory.map(p => p.z);

                        traces.push({
                            x: x,
                            y: y,
                            z: z,
                            mode: 'lines',
                            type: 'scatter3d',
                            name: `Drone ${droneId} (Historical)`,
                            line: {
                                width: 3,
                                color: DRONE_COLORS[droneId]
                            },
                            opacity: 0.8
                        });

                        // Add markers for key points
                        traces.push({
                            x: [x[0], x[x.length - 1]],
                            y: [y[0], y[y.length - 1]],
                            z: [z[0], z[z.length - 1]],
                            mode: 'markers',
                            type: 'scatter3d',
                            name: `Drone ${droneId} Points`,
                            marker: {
                                size: 5,
                                color: DRONE_COLORS[droneId],
                                symbol: ['circle', 'square']
                            },
                            showlegend: false
                        });
                    }
                });
            }

            // Plot future trajectories
            if (type === 'future' || type === 'both') {
                Object.keys(futureTrajectories).forEach(droneId => {
                    const trajectory = futureTrajectories[droneId];
                    if (trajectory && trajectory.length > 0) {
                        const x = trajectory.map(p => p.x);
                        const y = trajectory.map(p => p.y);
                        const z = trajectory.map(p => p.z);

                        traces.push({
                            x: x,
                            y: y,
                            z: z,
                            mode: 'lines',
                            type: 'scatter3d',
                            name: `Drone ${droneId} (Future)`,
                            line: {
                                width: 3,
                                color: DRONE_COLORS[droneId],
                                dash: 'dash'
                            },
                            opacity: 0.6
                        });
                    }
                });
            }

            // Add current positions
            currentDrones.forEach(drone => {
                const pos = drone.position || {};
                if (pos.x !== undefined && pos.y !== undefined && pos.z !== undefined) {
                    traces.push({
                        x: [pos.x],
                        y: [pos.y],
                        z: [pos.z],
                        mode: 'markers',
                        type: 'scatter3d',
                        name: `Drone ${drone.id} (Current)`,
                        marker: {
                            size: 8,
                            color: DRONE_COLORS[drone.id],
                            symbol: 'diamond'
                        }
                    });
                }
            });

            const layout = {
                title: '3D Trajectories Visualization',
                scene: {
                    xaxis: { title: 'X (m)' },
                    yaxis: { title: 'Y (m)' },
                    zaxis: { title: 'Altitude (m)' },
                    camera: {
                        eye: { x: 1.5, y: 1.5, z: 1.5 }
                    }
                },
                margin: { l: 0, r: 0, b: 0, t: 30 },
                height: 400
            };

            Plotly.newPlot('trajectory-3d-plot', traces, layout);
        }

        // Plot altitude chart
        function plotAltitudeChart() {
            const traces = [];

            Object.keys(historicalTrajectories).forEach(droneId => {
                const trajectory = historicalTrajectories[droneId];
                if (trajectory && trajectory.length > 0) {
                    const times = trajectory.map(p => new Date(p.timestamp));
                    const altitudes = trajectory.map(p => p.z);

                    traces.push({
                        x: times,
                        y: altitudes,
                        mode: 'lines',
                        type: 'scatter',
                        name: `Drone ${droneId}`,
                        line: { color: DRONE_COLORS[droneId], width: 2 }
                    });
                }
            });

            const layout = {
                title: 'Altitude Over Time',
                xaxis: { title: 'Time' },
                yaxis: { title: 'Altitude (m)' },
                showlegend: true
            };

            Plotly.newPlot('altitude-plot', traces, layout);
        }

        // Plot distance chart
        function plotDistanceChart() {
            const traces = [];
            const droneIds = Object.keys(historicalTrajectories);

            // Calculate cumulative distance for each drone
            droneIds.forEach(droneId => {
                const trajectory = historicalTrajectories[droneId];
                if (trajectory && trajectory.length > 1) {
                    let cumulativeDistance = 0;
                    const distances = [0];
                    const times = [new Date(trajectory[0].timestamp)];

                    for (let i = 1; i < trajectory.length; i++) {
                        const p1 = trajectory[i - 1];
                        const p2 = trajectory[i];
                        const dx = p2.x - p1.x;
                        const dy = p2.y - p1.y;
                        const dz = p2.z - p1.z;
                        const segmentDistance = Math.sqrt(dx * dx + dy * dy + dz * dz);
                        
                        cumulativeDistance += segmentDistance;
                        distances.push(cumulativeDistance);
                        times.push(new Date(p2.timestamp));
                    }

                    traces.push({
                        x: times,
                        y: distances,
                        mode: 'lines',
                        type: 'scatter',
                        name: `Drone ${droneId}`,
                        line: { color: DRONE_COLORS[droneId], width: 2 }
                    });
                }
            });

            const layout = {
                title: 'Cumulative Distance Traveled',
                xaxis: { title: 'Time' },
                yaxis: { title: 'Distance (m)' },
                showlegend: true
            };

            Plotly.newPlot('distance-plot', traces, layout);
        }

        // Load mission history
        async function loadMissionHistory() {
            try {
                const response = await fetch('/api/missions');
                const data = await response.json();

                if (data.success) {
                    missions = data.missions || [];
                    displayMissionHistory();
                }
            } catch (error) {
                console.error('Error loading mission history:', error);
                showError('mission-history', 'Failed to load mission history');
            }
        }

        // Display mission history
        function displayMissionHistory() {
            const container = document.getElementById('mission-history');
            
            if (missions.length === 0) {
                container.innerHTML = '<p>No missions found</p>';
                return;
            }

            let html = '';
            missions.slice(0, 10).forEach(mission => { // Show last 10 missions
                const statusClass = mission.status || 'unknown';
                const startTime = new Date(mission.start_time).toLocaleString();
                const endTime = new Date(mission.end_time).toLocaleString();

                html += `
                    <div class="mission-item ${statusClass}">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>Mission ${mission.mission_id} - Drone ${mission.drone_id}</strong>
                            <span style="font-size: 0.8em; color: #666;">${statusClass.toUpperCase()}</span>
                        </div>
                        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                            <div>Start: ${startTime}</div>
                            <div>End: ${endTime}</div>
                            ${mission.conflict_detected ? 
                                '<div style="color: #F44336;">⚠ Conflict Detected</div>' : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Load system statistics
        async function loadSystemStats() {
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();

                if (data.success) {
                    systemStats = data;
                    displaySystemStats();
                    plotStatsChart();
                }
            } catch (error) {
                console.error('Error loading system stats:', error);
                showError('system-stats', 'Failed to load system statistics');
            }
        }

        // Display system statistics
        function displaySystemStats() {
            const container = document.getElementById('system-stats');
            
            // Calculate additional statistics from trajectories
            const totalDistance = calculateTotalDistance();
            const avgAltitude = calculateAverageAltitude();
            const flightTime = calculateTotalFlightTime();

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${systemStats.drone_count || 0}</div>
                    <div class="stat-label">Active Drones</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${missions.length}</div>
                    <div class="stat-label">Total Missions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalDistance.toFixed(1)}m</div>
                    <div class="stat-label">Total Distance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgAltitude.toFixed(1)}m</div>
                    <div class="stat-label">Avg Altitude</div>
                </div>
            `;
        }

        // Calculate total distance from trajectories
        function calculateTotalDistance() {
            let total = 0;
            
            Object.values(historicalTrajectories).forEach(trajectory => {
                if (trajectory && trajectory.length > 1) {
                    for (let i = 1; i < trajectory.length; i++) {
                        const p1 = trajectory[i - 1];
                        const p2 = trajectory[i];
                        const dx = p2.x - p1.x;
                        const dy = p2.y - p1.y;
                        const dz = p2.z - p1.z;
                        total += Math.sqrt(dx * dx + dy * dy + dz * dz);
                    }
                }
            });
            
            return total;
        }

        // Calculate average altitude
        function calculateAverageAltitude() {
            let total = 0;
            let count = 0;
            
            Object.values(historicalTrajectories).forEach(trajectory => {
                if (trajectory && trajectory.length > 0) {
                    trajectory.forEach(point => {
                        total += point.z || 0;
                        count++;
                    });
                }
            });
            
            return count > 0 ? total / count : 0;
        }

        // Calculate total flight time
        function calculateTotalFlightTime() {
            let totalMinutes = 0;
            
            Object.values(historicalTrajectories).forEach(trajectory => {
                if (trajectory && trajectory.length > 1) {
                    const first = new Date(trajectory[0].timestamp);
                    const last = new Date(trajectory[trajectory.length - 1].timestamp);
                    totalMinutes += (last - first) / (1000 * 60);
                }
            });
            
            return totalMinutes;
        }

        // Plot statistics chart
        function plotStatsChart() {
            const droneIds = Object.keys(historicalTrajectories);
            const distances = [];
            const altitudes = [];

            droneIds.forEach(droneId => {
                const trajectory = historicalTrajectories[droneId];
                if (trajectory && trajectory.length > 0) {
                    // Calculate distance for this drone
                    let distance = 0;
                    let altitudeSum = 0;
                    
                    if (trajectory.length > 1) {
                        for (let i = 1; i < trajectory.length; i++) {
                            const p1 = trajectory[i - 1];
                            const p2 = trajectory[i];
                            const dx = p2.x - p1.x;
                            const dy = p2.y - p1.y;
                            const dz = p2.z - p1.z;
                            distance += Math.sqrt(dx * dx + dy * dy + dz * dz);
                        }
                    }
                    
                    // Calculate average altitude for this drone
                    trajectory.forEach(point => {
                        altitudeSum += point.z || 0;
                    });
                    
                    const avgAltitude = trajectory.length > 0 ? altitudeSum / trajectory.length : 0;
                    
                    distances.push(distance);
                    altitudes.push(avgAltitude);
                }
            });

            const trace1 = {
                x: droneIds,
                y: distances,
                type: 'bar',
                name: 'Distance (m)',
                marker: { color: '#667eea' }
            };

            const trace2 = {
                x: droneIds,
                y: altitudes,
                type: 'bar',
                name: 'Avg Altitude (m)',
                marker: { color: '#4CAF50' },
                yaxis: 'y2'
            };

            const layout = {
                title: 'Drone Performance Comparison',
                xaxis: { title: 'Drone ID' },
                yaxis: { title: 'Distance (m)' },
                yaxis2: {
                    title: 'Altitude (m)',
                    overlaying: 'y',
                    side: 'right'
                },
                barmode: 'group'
            };

            Plotly.newPlot('stats-chart', [trace1, trace2], layout);
        }

        // Load conflict history
        async function loadConflictHistory() {
            try {
                // This would come from a real API endpoint
                // For now, we'll simulate some conflicts
                conflicts = [
                    {
                        drone1: 1,
                        drone2: 2,
                        distance: 1.5,
                        timestamp: new Date().toISOString(),
                        severity: 'high'
                    },
                    {
                        drone1: 3,
                        drone2: 4,
                        distance: 2.0,
                        timestamp: new Date(Date.now() - 300000).toISOString(),
                        severity: 'medium'
                    }
                ];
                
                displayConflictHistory();
            } catch (error) {
                console.error('Error loading conflict history:', error);
            }
        }

        // Display conflict history
        function displayConflictHistory() {
            const container = document.getElementById('conflict-history');
            
            if (conflicts.length === 0) {
                container.innerHTML = '<p>No conflicts detected</p>';
                return;
            }

            let html = '<div class="info-grid">';
            conflicts.forEach(conflict => {
                const time = new Date(conflict.timestamp).toLocaleString();
                const severityColor = conflict.severity === 'high' ? '#F44336' : 
                                     conflict.severity === 'medium' ? '#FF9800' : '#4CAF50';

                html += `
                    <div class="info-item">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>Drone ${conflict.drone1} ↔ Drone ${conflict.drone2}</strong>
                            <span style="color: ${severityColor}">${conflict.severity.toUpperCase()}</span>
                        </div>
                        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                            <div>Distance: ${conflict.distance.toFixed(2)}m</div>
                            <div>Time: ${time}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // Update legend
        function updateLegend() {
            const legend = document.getElementById('trajectory-legend');
            let html = '';

            Object.keys(DRONE_COLORS).forEach(droneId => {
                html += `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${DRONE_COLORS[droneId]}"></div>
                        <span>Drone ${droneId}</span>
                    </div>
                `;
            });

            legend.innerHTML = html;
        }

        // Toggle trajectory view
        function toggleTrajectoryView() {
            // This could switch between different camera angles or visualization modes
            plot3DTrajectories('both');
        }

        // Reset time range to now
        function resetTimeRange() {
            const endTime = new Date();
            const startTime = new Date(endTime.getTime() - (60 * 60 * 1000));
            
            document.getElementById('start-time').value = formatDateTimeLocal(startTime);
            document.getElementById('end-time').value = formatDateTimeLocal(endTime);
            
            loadHistoricalData();
        }

        // Download all trajectories
        async function downloadAllTrajectories() {
            try {
                const data = {
                    drones: currentDrones,
                    historicalTrajectories: historicalTrajectories,
                    futureTrajectories: futureTrajectories,
                    missions: missions,
                    timestamp: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uav_trajectories_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error downloading data:', error);
                alert('Failed to download data');
            }
        }

        // Load drone details
        async function loadDroneDetails() {
            await loadDroneStatus();
            await loadHistoricalData();
        }

        // Show error message
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="error">${message}</div>`;
            }
        }
    </script>
</body>

</html>