<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone History - UAV Deconfliction System</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
            color: #667eea;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            color: #333;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: #667eea;
            color: white;
        }
        
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }
        
        .drone-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .info-label {
            font-weight: 600;
            color: #666;
            display: block;
            margin-bottom: 5px;
        }
        
        .mission-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .mission-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .mission-item.completed {
            border-left-color: #4CAF50;
        }
        
        .mission-item.failed {
            border-left-color: #F44336;
        }
        
        .mission-item.active {
            border-left-color: #FF9800;
        }
        
        .plot-container {
            height: 400px;
            width: 100%;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #667eea;
            color: white;
            text-decoration: none;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-history"></i>
                <div>
                    <h1>Drone {{ drone_id }} - Flight History</h1>
                    <p>UAV Deconfliction System</p>
                </div>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="/visualization" class="nav-link"><i class="fas fa-map"></i> Visualization</a>
                <a href="/history/{{ drone_id }}" class="nav-link active"><i class="fas fa-history"></i> History</a>
            </div>
        </header>
        
        <div class="history-grid">
            <!-- Drone Information -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-drone"></i> Drone Information</h2>
                    <span id="drone-status" class="status-indicator">Loading...</span>
                </div>
                <div class="drone-info">
                    <h3>Drone {{ drone_id }}</h3>
                    <div class="info-grid" id="drone-details">
                        <div class="loading">Loading drone information...</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <a href="/api/trajectory/{{ drone_id }}" class="btn" target="_blank">
                        <i class="fas fa-download"></i> Download Trajectory Data
                    </a>
                </div>
            </div>
            
            <!-- Mission History -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-tasks"></i> Mission History</h2>
                </div>
                <div class="mission-list" id="mission-history">
                    <div class="loading">Loading mission history...</div>
                </div>
            </div>
            
            <!-- Trajectory Plot -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-line"></i> Trajectory Analysis</h2>
                </div>
                <div class="plot-container" id="trajectory-plot"></div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn" onclick="plot2DTrajectory()">
                        <i class="fas fa-map"></i> 2D Plot
                    </button>
                    <button class="btn" onclick="plot3DTrajectory()">
                        <i class="fas fa-cube"></i> 3D Plot
                    </button>
                    <button class="btn" onclick="plotAltitudeChart()">
                        <i class="fas fa-mountain"></i> Altitude
                    </button>
                </div>
            </div>
            
            <!-- Statistics -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-bar"></i> Flight Statistics</h2>
                </div>
                <div id="flight-stats">
                    <div class="loading">Loading statistics...</div>
                </div>
                <div class="plot-container" id="stats-plot" style="height: 200px;"></div>
            </div>
        </div>
        
        <footer>
            <p>UAV Deconfliction System | FlytBase Robotics Assignment 2025</p>
            <p>Flight history and trajectory analysis for Drone {{ drone_id }}</p>
        </footer>
    </div>
    
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        const droneId = {{ drone_id }};
        
        // Load drone information
        async function loadDroneInfo() {
            try {
                const response = await fetch('/api/drones');
                const data = await response.json();
                
                if (data.success && data.drones && data.drones[droneId]) {
                    const drone = data.drones[droneId];
                    const position = drone.position || {};
                    
                    document.getElementById('drone-status').textContent = drone.status || 'Unknown';
                    document.getElementById('drone-status').style.color = 
                        drone.armed ? '#4CAF50' : '#FF9800';
                    
                    const details = document.getElementById('drone-details');
                    details.innerHTML = `
                        <div class="info-item">
                            <span class="info-label">Status:</span>
                            <span>${drone.status || 'Unknown'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Armed:</span>
                            <span>${drone.armed ? 'Yes' : 'No'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Mode:</span>
                            <span>${drone.mode || 'Unknown'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Battery:</span>
                            <span>${drone.battery || 'N/A'}%</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Position (X, Y, Z):</span>
                            <span>${position.x?.toFixed(1) || 'N/A'}, 
                                  ${position.y?.toFixed(1) || 'N/A'}, 
                                  ${position.z?.toFixed(1) || 'N/A'}m</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">GPS:</span>
                            <span>${position.lat?.toFixed(6) || 'N/A'}, 
                                  ${position.lon?.toFixed(6) || 'N/A'}</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading drone info:', error);
            }
        }
        
        // Load mission history
        async function loadMissionHistory() {
            try {
                const response = await fetch('/api/missions');
                const data = await response.json();
                
                const missionList = document.getElementById('mission-history');
                
                if (data.success && data.missions) {
                    const droneMissions = data.missions.filter(m => m.drone_id == droneId);
                    
                    if (droneMissions.length === 0) {
                        missionList.innerHTML = '<p>No missions found for this drone</p>';
                        return;
                    }
                    
                    let html = '';
                    droneMissions.forEach(mission => {
                        const statusClass = mission.status || 'unknown';
                        const startTime = new Date(mission.start_time).toLocaleString();
                        const endTime = new Date(mission.end_time).toLocaleString();
                        
                        html += `
                            <div class="mission-item ${statusClass}">
                                <strong>Mission ${mission.mission_id}</strong><br>
                                <small>Status: ${mission.status}</small><br>
                                <small>Start: ${startTime}</small><br>
                                <small>End: ${endTime}</small>
                                ${mission.conflict_detected ? '<br><small style="color: #F44336;">âš  Conflict Detected</small>' : ''}
                            </div>
                        `;
                    });
                    
                    missionList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading mission history:', error);
            }
        }
        
        // Plot 2D trajectory
        function plot2DTrajectory() {
            // Sample trajectory data (in real system, fetch from API)
            const x = [];
            const y = [];
            
            for (let i = 0; i < 50; i++) {
                x.push(Math.sin(i * 0.2) * 20 + Math.random() * 5);
                y.push(Math.cos(i * 0.2) * 20 + Math.random() * 5);
            }
            
            const trace = {
                x: x,
                y: y,
                mode: 'lines+markers',
                type: 'scatter',
                name: 'Trajectory',
                line: { color: '#667eea', width: 2 },
                marker: { size: 4 }
            };
            
            const layout = {
                title: '2D Trajectory Path',
                xaxis: { title: 'X (m)' },
                yaxis: { title: 'Y (m)' },
                showlegend: false
            };
            
            Plotly.newPlot('trajectory-plot', [trace], layout);
        }
        
        // Plot 3D trajectory
        function plot3DTrajectory() {
            const x = [], y = [], z = [];
            
            for (let i = 0; i < 50; i++) {
                x.push(Math.sin(i * 0.2) * 20);
                y.push(Math.cos(i * 0.2) * 20);
                z.push(i * 2);
            }
            
            const trace = {
                x: x,
                y: y,
                z: z,
                mode: 'lines+markers',
                type: 'scatter3d',
                line: { width: 4, color: z, colorscale: 'Viridis' },
                marker: { size: 3, color: z, colorscale: 'Viridis' }
            };
            
            const layout = {
                title: '3D Trajectory',
                scene: {
                    xaxis: { title: 'X (m)' },
                    yaxis: { title: 'Y (m)' },
                    zaxis: { title: 'Altitude (m)' }
                }
            };
            
            Plotly.newPlot('trajectory-plot', [trace], layout);
        }
        
        // Plot altitude chart
        function plotAltitudeChart() {
            const time = [];
            const altitude = [];
            
            for (let i = 0; i < 24; i++) {
                time.push(`${i.toString().padStart(2, '0')}:00`);
                altitude.push(10 + Math.sin(i * 0.5) * 8 + Math.random() * 3);
            }
            
            const trace = {
                x: time,
                y: altitude,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Altitude',
                line: { color: '#4CAF50', width: 2 },
                marker: { size: 6 }
            };
            
            const layout = {
                title: 'Altitude Over Time',
                xaxis: { title: 'Time' },
                yaxis: { title: 'Altitude (m)' }
            };
            
            Plotly.newPlot('trajectory-plot', [trace], layout);
        }
        
        // Load flight statistics
        async function loadFlightStats() {
            const statsDiv = document.getElementById('flight-stats');
            
            // Sample statistics (in real system, calculate from database)
            const stats = {
                totalMissions: 15,
                completedMissions: 12,
                totalFlightTime: '8h 45m',
                totalDistance: '45.2 km',
                conflictsDetected: 3,
                avgAltitude: '25.4 m'
            };
            
            statsDiv.innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Total Missions:</span>
                        <span>${stats.totalMissions}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Completed:</span>
                        <span>${stats.completedMissions}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Flight Time:</span>
                        <span>${stats.totalFlightTime}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Total Distance:</span>
                        <span>${stats.totalDistance}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Conflicts:</span>
                        <span>${stats.conflictsDetected}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Avg Altitude:</span>
                        <span>${stats.avgAltitude}</span>
                    </div>
                </div>
            `;
            
            // Plot mission success rate
            const missionTrace = {
                x: ['Completed', 'Failed', 'Cancelled'],
                y: [12, 2, 1],
                type: 'bar',
                marker: {
                    color: ['#4CAF50', '#F44336', '#FF9800']
                }
            };
            
            const missionLayout = {
                title: 'Mission Success Rate',
                showlegend: false
            };
            
            Plotly.newPlot('stats-plot', [missionTrace], missionLayout);
        }
        
        // Initialize
        window.onload = function() {
            loadDroneInfo();
            loadMissionHistory();
            loadFlightStats();
            plot2DTrajectory(); // Default plot
            
            // Refresh drone info every 10 seconds
            setInterval(loadDroneInfo, 10000);
        };
    </script>
</body>
</html>
